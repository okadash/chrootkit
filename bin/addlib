#!/bin/sh 
# chroot builder for /bin/sh
# usage: addlib [<executable>, ...] <destination>
#  (requirement) readlinkf, gnu awk
command -v readlinkf || alias readlinkf="readlink -f"
throw(){ echo $* >&2; exit 1;}

: ${1:?executable not specified!}
: ${2:?chroot destination not specified!}

root="$(eval echo \$$#)"
: ${root:? root not set!}

filter_library_path(){
  sed -r -e "s/^(.*=>)?[[:blank:]]*//g" -e s/\ \.\+//g | grep /
}

while [ $# -gt 1 ] ; do

  fullpath="$(command -v $1)"
  : ${fullpath:?fullpath not set!}
  file_fullpath="$(readlinkf $fullpath)"
  : ${file_fullpath:?file_fullpath not set!}

  for i in \
    $(ldd $fullpath | filter_library_path) \
    $(ldd $file_fullpath | filter_library_path) 
  do 
    tdir="$root/${i%/*}"; 
    [ ! -d "$tdir" ] && mkdir -vp "$tdir"; 
    cp -v "$i" "$root"/"$i"; 
  done

  [ ! -d "$root/${fullpath%/*}" ] && mkdir -vp "$root/${fullpath%/*}"
  [ ! -d "$root/${file_fullpath%/*}" ] && mkdir -vp "$root/${file_fullpath%/*}"
  cp -v "$fullpath" "$root/${fullpath%/*}"
  cp -v "$file_fullpath" "$root/${file_fullpath%/*}"
  shift;
done


